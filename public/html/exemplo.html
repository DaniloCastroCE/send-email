<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Enviar Email com Imagens</title>

    <style>
        /* Estilos b√°sicos da p√°gina */
        body {
            font-family: Arial;
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
        }

        /* Inputs e bot√µes com tamanho e espa√ßamento */
        input,
        button {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
        }

        /* Editor de texto com borda e altura m√≠nima */
        #bodyEditor {
            width: 100%;
            min-height: 200px;
            border: 1px solid #aaa;
            padding: 10px;
            margin-top: 10px;
            border-radius: 6px;
        }

        /* Miniaturas das imagens adicionadas */
        #preview img {
            max-width: 200px;
            margin: 5px;
            border: 1px solid #ccc;
            padding: 3px;
            border-radius: 5px;
        }

    </style>
</head>

<body>

    <h2>Enviar Email com Anexos e Imagens pelo Conte√∫do</h2>

    <!-- Formul√°rio principal onde os dados ser√£o preenchidos -->
    <form id="emailForm">

        <!-- Campos obrigat√≥rios -->
        <input type="email" name="from" placeholder="Seu e-mail (from)" required>
        <input type="password" name="password" placeholder="Senha app (password)" required>
        <input type="email" name="to" placeholder="Destinat√°rio (to)" required>
        <input type="text" name="subject" placeholder="Assunto (subject)">

        <h3>Corpo do e-mail:</h3>

        <!-- Editor de conte√∫do do e-mail (aceita imagens coladas) -->
        <div id="bodyEditor" contenteditable="true"></div>

        <h3>Anexar imagens:</h3>

        <!-- Input para anexar imagens manualmente -->
        <input type="file" id="fileInput" accept="image/*" multiple>

        <h3>Imagens adicionadas (coladas ou anexadas):</h3>

        <!-- Mostra todas as imagens que foram carregadas ou coladas -->
        <div id="preview"></div>

        <button type="submit" id="buttonSubmit">Enviar Email</button>
    </form>

    <script>
        /* Refer√™ncias aos elementos do DOM */
        const bodyEditor = document.getElementById("bodyEditor");
        const fileInput = document.getElementById("fileInput");
        const preview = document.getElementById("preview");

        /* Arrays para armazenar imagens */
        let pastedImages = [];   // imagens coladas no editor
        let attachedImages = []; // imagens anexadas via input file

        /* --------------------------------------------------------
           Fun√ß√£o para adicionar imagem ao editor + preview
        ---------------------------------------------------------*/
        function addImageToEditor(file) {
            const reader = new FileReader();

            // Quando o arquivo for lido
            reader.onload = () => {
                /* ---- Inserir imagem dentro do editor visual ---- */
                const img = document.createElement("img");
                img.src = reader.result; // Base64 da imagem
                bodyEditor.appendChild(img);

                /* ---- Mostrar miniatura abaixo (preview) ---- */
                const prev = document.createElement("img");
                prev.src = reader.result;
                preview.appendChild(prev);
            };

            // L√™ o arquivo como Base64
            reader.readAsDataURL(file);
        }

        /* --------------------------------------------------------
           Evento: COLAR imagens no editor (Firefox + Chrome)
        ---------------------------------------------------------*/
        bodyEditor.addEventListener("paste", (event) => {
            event.preventDefault(); // impede colagem padr√£o
            const clipboard = event.clipboardData;

            /* üî• SUPORTE PARA FIREFOX 
               Firefox coloca imagens em clipboard.files
            ---------------------------------------------------------*/
            if (clipboard.files && clipboard.files.length > 0) {
                for (const file of clipboard.files) {
                    if (file.type.startsWith("image/")) { // garante que √© imagem
                        pastedImages.push(file);
                        addImageToEditor(file);
                    }
                }
                return; // encerra o fluxo para Firefox
            }

            /* üî• SUPORTE PARA CHROME / EDGE 
               Chrome coloca imagens em clipboard.items
            ---------------------------------------------------------*/
            const items = clipboard.items;
            for (let i = 0; i < items.length; i++) {
                const item = items[i];

                if (item.type.indexOf("image") === 0) {
                    const blob = item.getAsFile(); // converte item para arquivo
                    pastedImages.push(blob);
                    addImageToEditor(blob);
                }
            }
        });

        /* --------------------------------------------------------
           Evento: Selecionar imagens manualmente no <input>
        ---------------------------------------------------------*/
        fileInput.addEventListener("change", () => {
            for (const file of fileInput.files) {
                if (file.type.startsWith("image/")) {
                    attachedImages.push(file);
                    addImageToEditor(file);
                }
            }
        });

        /* --------------------------------------------------------
           Envio do formul√°rio para o servidor
        ---------------------------------------------------------*/
        document.getElementById("emailForm").addEventListener("submit", async (e) => {
            e.preventDefault(); // evita recarregar a p√°gina

            const buttonSubmit = document.querySelector('#buttonSubmit')
            buttonSubmit.disabled = true // Desabilita o bot√£o de envio para evitar m√∫ltiplos envios

            const formData = new FormData(e.target);

            // Adiciona o conte√∫do atual do editor ao formul√°rio
            formData.append("body", bodyEditor.innerHTML);

            /* Adiciona imagens coladas ao FormData */
            pastedImages.forEach((file) => {
                formData.append("files", file);
            });

            /* Adiciona imagens anexadas manualmente */
            attachedImages.forEach((file) => {
                formData.append("files", file);
            });

            /* Faz a requisi√ß√£o para o seu backend */
            const response = await fetch("https://api-danilo-send-email.vercel.app/send-email", {
                method: "POST",
                body: formData
            });

            const result = await response.json();

            /* Mostra a resposta do servidor */
            alert("Status: " + result.status + "\n" + result.message);
            buttonSubmit.disabled = false // Habilita o bot√£o de envio novamente
        });
    </script>

</body>

</html>